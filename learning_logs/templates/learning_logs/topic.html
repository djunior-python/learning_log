{% extends 'learning_logs/base.html' %}

{% block page_header %}
<h3>{{ topic }}</h3>
{% endblock page_header %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        {% if topic.owner == user %}
            <a href="{% url 'learning_logs:new_entry' topic.id %}" class="btn btn-primary btn-sm">Add new entry</a>
        {% endif %}
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ª–∞–π–∫—É -->
    {% if topic.is_public and topic.owner != user %}
        <button id="like-btn"
                data-topic-id="{{ topic.id }}"
                class="btn btn-outline-danger btn-sm">
            ‚ù§Ô∏è Like (<span id="like-count">{{ topic.likes.count }}</span>)
        </button>
    {% endif %}
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—Ä–≥–∏ -->
    {% if user.is_authenticated and topic.owner != user %}
        <a href="{% url 'learning_logs:create_complaint' topic.id %}" 
           class="btn btn-outline-warning btn-sm">
           üö© To complain
        </a>
    {% endif %}
</div>

{% for entry in entries %}
<div class="card mb-3">
    <h4 class="card-header">
        {{ entry.date_added|date:'M d, Y H:i' }}
        <small><a href="{% url 'learning_logs:entry_detail' entry.id %}">read entry &raquo;</a></small>
        {% if topic.owner == user %}
            <small><a href="{% url 'learning_logs:edit_entry' entry.id %}">edit entry &raquo;</a></small>
            <small><a href="{% url 'learning_logs:delete_entry' entry.id %}">delete entry &raquo;</a></small>
        {% endif %}
    </h4>
    <div class="card-body">
        {{ entry.text|linebreaks }}
    </div>
</div>
{% empty %}
<p>There are no entries for this topic yet.</p>
{% endfor %}

<!-- JS –∫–æ–¥ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const likeBtn = document.getElementById('like-btn');
    if (!likeBtn) return;

    likeBtn.addEventListener('click', () => {
        const topicId = likeBtn.dataset.topicId;
        fetch(`/like_topic/${topicId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('like-count').innerText = data.likes_count;
            likeBtn.classList.toggle('btn-danger', data.liked);
            likeBtn.classList.toggle('btn-outline-danger', !data.liked);
        });
    });

    // –û—Ç—Ä–∏–º—É—î CSRF-—Ç–æ–∫–µ–Ω —ñ–∑ cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock content %}